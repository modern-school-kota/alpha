<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete School Timetable Generator</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #2c3e50 0%, #4a6491 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #fff, #f0f0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .tab-container {
            display: flex;
            background: #34495e;
            padding: 0 30px;
        }
        
        .tab {
            padding: 18px 30px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 4px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: #2c3e50;
            border-bottom-color: #3498db;
        }
        
        .tab:hover {
            background: #3a506b;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .config-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .data-management {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
        }
        
        .data-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #e9ecef;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .data-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
        }
        
        input, select, textarea, button {
            width: 100%;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.2);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-generate {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            padding: 18px;
            font-size: 1.2rem;
        }
        
        .btn-export {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
        }
        
        .btn-reset {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .timetable-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 10px;
            border: 1px solid #ddd;
            max-height: 600px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }
        
        th {
            background: #2c3e50;
            color: white;
            padding: 18px;
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 15px;
            border: 1px solid #e9ecef;
            text-align: center;
            vertical-align: middle;
            transition: background 0.3s;
        }
        
        .time-slot {
            background: #34495e;
            color: white;
            font-weight: 600;
            position: sticky;
            left: 0;
            z-index: 5;
        }
        
        .subject-cell {
            background: #e8f4fc;
            border-radius: 6px;
            cursor: pointer;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 10px;
            transition: all 0.3s;
        }
        
        .subject-cell:hover {
            background: #d1ecf1;
            transform: scale(1.02);
        }
        
        .conflict {
            background: #ffcccc !important;
            animation: pulse 2s infinite;
            position: relative;
            overflow: hidden;
        }
        
        .conflict::after {
            content: "‚ö†Ô∏è";
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 12px;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }
        
        .subject-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .teacher-name {
            font-size: 0.9rem;
            color: #3498db;
            font-weight: 500;
        }
        
        .room-number {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
            padding: 25px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 10px;
        }
        
        .stat-label {
            font-size: 1rem;
            color: #7f8c8d;
            font-weight: 600;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .class-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .class-tab {
            padding: 12px 25px;
            background: white;
            border: 2px solid #3498db;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #3498db;
            transition: all 0.3s;
        }
        
        .class-tab.active {
            background: #3498db;
            color: white;
        }
        
        .class-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.2);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .data-table th {
            background: #34495e;
            padding: 12px;
            text-align: left;
        }
        
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
            border-left: 5px solid #c62828;
        }
        
        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
            border-left: 5px solid #2e7d32;
        }
        
        .export-options {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .config-section, .data-management {
                grid-template-columns: 1fr;
            }
            
            .tab-container {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1;
                text-align: center;
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè´ Complete School Timetable Generator</h1>
            <p class="subtitle">Advanced AI-powered timetable generation with unlimited classes, sections, and comprehensive teacher-subject management</p>
        </header>
        
        <div class="tab-container">
            <div class="tab active" data-tab="config">‚öôÔ∏è Configuration</div>
            <div class="tab" data-tab="data">üìä Data Management</div>
            <div class="tab" data-tab="timetable">üìÖ Generated Timetables</div>
            <div class="tab" data-tab="export">üì§ Export</div>
        </div>
        
        <!-- Configuration Tab -->
        <div id="config" class="tab-content active">
            <h2 style="color: #2c3e50; margin-bottom: 25px;">‚öôÔ∏è School Configuration</h2>
            
            <div class="config-section">
                <div class="data-card">
                    <h3 style="color: #3498db; margin-bottom: 20px;">üè´ School Structure</h3>
                    
                    <div class="form-group">
                        <label for="schoolDays">School Days per Week:</label>
                        <input type="number" id="schoolDays" min="3" max="7" value="6">
                    </div>
                    
                    <div class="form-group">
                        <label for="periodsPerDay">Periods per Day:</label>
                        <input type="number" id="periodsPerDay" min="5" max="12" value="8">
                    </div>
                    
                    <div class="form-group">
                        <label for="periodDuration">Period Duration (minutes):</label>
                        <input type="number" id="periodDuration" min="30" max="90" value="45">
                    </div>
                    
                    <div class="form-group">
                        <label for="breakPeriods">Break Periods (comma-separated):</label>
                        <input type="text" id="breakPeriods" value="3,6" placeholder="e.g., 3,6">
                    </div>
                </div>
                
                <div class="data-card">
                    <h3 style="color: #3498db; margin-bottom: 20px;">üìö Subject Management</h3>
                    
                    <div class="form-group">
                        <label for="subjectInput">Enter Subjects (one per line):</label>
                        <textarea id="subjectInput" rows="6" placeholder="Mathematics
Physics
Chemistry
Biology
English
History
Geography
Computer Science
Physical Education
Art
Music">Mathematics
Physics
Chemistry
Biology
English
History
Geography
Computer Science
Physical Education
Art
Music</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="labSubjects">Lab Subjects (select multiple):</label>
                        <select id="labSubjects" multiple style="height: 120px;">
                            <option value="Physics">Physics</option>
                            <option value="Chemistry">Chemistry</option>
                            <option value="Biology">Biology</option>
                            <option value="Computer Science">Computer Science</option>
                        </select>
                    </div>
                </div>
                
                <div class="data-card">
                    <h3 style="color: #3498db; margin-bottom: 20px;">üë®‚Äçüè´ Teacher Management</h3>
                    
                    <div class="form-group">
                        <label for="teacherInput">Enter Teachers (one per line):</label>
                        <textarea id="teacherInput" rows="6" placeholder="Format: Name,Subject1,Subject2,MaxPeriodsPerDay
Example: John Smith,Mathematics,Physics,6">John Smith,Mathematics,Physics,6
Sarah Johnson,Chemistry,Biology,5
Robert Brown,English,History,6
Emily Davis,Geography,Computer Science,5
Michael Wilson,Physical Education,6
Lisa Taylor,Art,Music,4
David Miller,Physics,Mathematics,6
Jennifer Lee,Biology,Chemistry,5</textarea>
                    </div>
                </div>
                
                <div class="data-card">
                    <h3 style="color: #3498db; margin-bottom: 20px;">üë• Class & Section Setup</h3>
                    
                    <div class="form-group">
                        <label for="classesInput">Enter Classes & Sections (one per line):</label>
                        <textarea id="classesInput" rows="6" placeholder="Format: ClassName,SectionCount
Example: Grade 9,3
Grade 10,4">Grade 6,2
Grade 7,3
Grade 8,3
Grade 9,4
Grade 10,4
Grade 11,3
Grade 12,2</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="roomCount">Number of Classrooms:</label>
                        <input type="number" id="roomCount" min="10" max="50" value="25">
                    </div>
                    
                    <div class="form-group">
                        <label for="labCount">Number of Laboratories:</label>
                        <input type="number" id="labCount" min="1" max="10" value="4">
                    </div>
                </div>
            </div>
            
            <div class="stats-panel">
                <div class="stat-card">
                    <div class="stat-value" id="totalSubjects">0</div>
                    <div class="stat-label">Total Subjects</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="totalTeachers">0</div>
                    <div class="stat-label">Total Teachers</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="totalClasses">0</div>
                    <div class="stat-label">Total Classes</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="totalSections">0</div>
                    <div class="stat-label">Total Sections</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="totalSlots">0</div>
                    <div class="stat-label">Total Time Slots</div>
                </div>
            </div>
            
            <button class="btn btn-generate" id="generateBtn">
                <span>üöÄ Generate Complete Timetable</span>
            </button>
            
            <div class="error-message" id="errorMsg"></div>
            <div class="success-message" id="successMsg"></div>
        </div>
        
        <!-- Data Management Tab -->
        <div id="data" class="tab-content">
            <h2 style="color: #2c3e50; margin-bottom: 25px;">üìä Data Overview</h2>
            
            <div class="data-management">
                <div class="data-card">
                    <h3 style="color: #3498db; margin-bottom: 20px;">üìö Subjects List</h3>
                    <table class="data-table" id="subjectsTable">
                        <thead>
                            <tr>
                                <th>Subject</th>
                                <th>Type</th>
                                <th>Teachers</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                
                <div class="data-card">
                    <h3 style="color: #3498db; margin-bottom: 20px;">üë®‚Äçüè´ Teachers & Subjects</h3>
                    <table class="data-table" id="teachersTable">
                        <thead>
                            <tr>
                                <th>Teacher</th>
                                <th>Subjects</th>
                                <th>Max Periods/Day</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                
                <div class="data-card">
                    <h3 style="color: #3498db; margin-bottom: 20px;">üë• Classes & Sections</h3>
                    <table class="data-table" id="classesTable">
                        <thead>
                            <tr>
                                <th>Class</th>
                                <th>Sections</th>
                                <th>Total Students</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                
                <div class="data-card">
                    <h3 style="color: #3498db; margin-bottom: 20px;">üè¢ Rooms & Labs</h3>
                    <table class="data-table" id="roomsTable">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Number</th>
                                <th>Capacity</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-generate" id="refreshDataBtn">
                    <span>üîÑ Refresh Data View</span>
                </button>
            </div>
        </div>
        
        <!-- Timetable Tab -->
        <div id="timetable" class="tab-content">
            <h2 style="color: #2c3e50; margin-bottom: 25px;">üìÖ Generated Timetables</h2>
            
            <div class="class-selector" id="classSelector">
                <!-- Class tabs will be generated here -->
            </div>
            
            <div class="timetable-container" id="mainTimetable">
                <p style="padding: 40px; text-align: center; color: #666; font-size: 1.2rem;">
                    No timetable generated yet. Please configure the system and click "Generate Complete Timetable".
                </p>
            </div>
            
            <div class="stats-panel" id="timetableStats">
                <div class="stat-card">
                    <div class="stat-value" id="conflictCount">0</div>
                    <div class="stat-label">Total Conflicts</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="teacherUtilization">0%</div>
                    <div class="stat-label">Teacher Utilization</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="roomUtilization">0%</div>
                    <div class="stat-label">Room Utilization</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="fitnessScore">0%</div>
                    <div class="stat-label">Overall Fitness</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="generationCount">0</div>
                    <div class="stat-label">Generations</div>
                </div>
            </div>
        </div>
        
        <!-- Export Tab -->
        <div id="export" class="tab-content">
            <h2 style="color: #2c3e50; margin-bottom: 25px;">üì§ Export Timetables</h2>
            
            <div class="data-card">
                <h3 style="color: #3498db; margin-bottom: 20px;">Export Options</h3>
                
                <div class="export-options">
                    <button class="btn btn-export" id="exportPDF">
                        <span>üìÑ Export as PDF</span>
                    </button>
                    
                    <button class="btn btn-export" id="exportExcel">
                        <span>üìä Export as Excel</span>
                    </button>
                    
                    <button class="btn btn-export" id="exportJSON">
                        <span>üîß Export as JSON</span>
                    </button>
                    
                    <button class="btn btn-export" id="exportCSV">
                        <span>üìã Export as CSV</span>
                    </button>
                </div>
                
                <div style="margin-top: 30px;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">Individual Class Exports:</h4>
                    <div id="classExportButtons"></div>
                </div>
                
                <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">Export Preview:</h4>
                    <pre id="exportPreview" style="background: white; padding: 15px; border-radius: 6px; max-height: 300px; overflow: auto; font-family: monospace;"></pre>
                </div>
            </div>
        </div>
    </div>
    
    <div class="loading" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <h3>üîÑ Generating Complete Timetable</h3>
        <p>This may take a moment. Processing <span id="currentGen">0</span> generations...</p>
        <p id="loadingDetails">Initializing data structures...</p>
        <div style="margin-top: 20px; width: 300px; height: 10px; background: #f0f0f0; border-radius: 5px; overflow: hidden;">
            <div id="progressBar" style="height: 100%; background: #3498db; width: 0%; transition: width 0.3s;"></div>
        </div>
    </div>

    <script>
        class CompleteTimetableGenerator {
            constructor() {
                this.schoolData = {
                    days: 6,
                    periods: 8,
                    periodDuration: 45,
                    breakPeriods: [3, 6],
                    subjects: [],
                    teachers: [],
                    classes: [],
                    rooms: [],
                    labs: [],
                    timetables: null
                };
                
                this.optimizationStats = {
                    conflicts: 0,
                    teacherUtilization: 0,
                    roomUtilization: 0,
                    fitness: 0,
                    generations: 0
                };
                
                this.currentClassView = null;
                this.initializeEventListeners();
                this.loadDefaultData();
            }
            
            initializeEventListeners() {
                // Tab switching
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => this.switchTab(tab.dataset.tab));
                });
                
                // Configuration events
                document.getElementById('generateBtn').addEventListener('click', () => this.generateCompleteTimetable());
                document.getElementById('refreshDataBtn').addEventListener('click', () => this.updateDataView());
                
                // Export events
                document.getElementById('exportPDF').addEventListener('click', () => this.exportAsPDF());
                document.getElementById('exportExcel').addEventListener('click', () => this.exportAsExcel());
                document.getElementById('exportJSON').addEventListener('click', () => this.exportAsJSON());
                document.getElementById('exportCSV').addEventListener('click', () => this.exportAsCSV());
                
                // Input change events
                ['schoolDays', 'periodsPerDay', 'periodDuration', 'breakPeriods', 
                 'subjectInput', 'teacherInput', 'classesInput', 'roomCount', 'labCount'].forEach(id => {
                    document.getElementById(id).addEventListener('change', () => this.updateStats());
                });
            }
            
            loadDefaultData() {
                this.updateStats();
            }
            
            switchTab(tabName) {
                // Hide all tabs
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Remove active class from all tabs
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Show selected tab
                document.getElementById(tabName).classList.add('active');
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                
                // Update data view if switching to data tab
                if (tabName === 'data') {
                    this.updateDataView();
                } else if (tabName === 'timetable' && this.currentClassView) {
                    this.displayTimetable(this.currentClassView);
                }
            }
            
            updateStats() {
                // Parse subjects
                const subjectText = document.getElementById('subjectInput').value;
                const subjects = subjectText.split('\n').filter(s => s.trim()).map(s => s.trim());
                
                // Parse teachers
                const teacherText = document.getElementById('teacherInput').value;
                const teachers = teacherText.split('\n').filter(t => t.trim());
                
                // Parse classes
                const classText = document.getElementById('classesInput').value;
                const classEntries = classText.split('\n').filter(c => c.trim());
                
                // Calculate total sections
                let totalSections = 0;
                classEntries.forEach(entry => {
                    const parts = entry.split(',');
                    if (parts.length >= 2) {
                        totalSections += parseInt(parts[1]) || 1;
                    }
                });
                
                // Update stat display
                document.getElementById('totalSubjects').textContent = subjects.length;
                document.getElementById('totalTeachers').textContent = teachers.length;
                document.getElementById('totalClasses').textContent = classEntries.length;
                document.getElementById('totalSections').textContent = totalSections;
                
                // Calculate total slots
                const days = parseInt(document.getElementById('schoolDays').value) || 6;
                const periods = parseInt(document.getElementById('periodsPerDay').value) || 8;
                const totalSlots = days * periods * totalSections;
                document.getElementById('totalSlots').textContent = totalSlots.toLocaleString();
            }
            
            updateDataView() {
                this.updateSubjectsTable();
                this.updateTeachersTable();
                this.updateClassesTable();
                this.updateRoomsTable();
            }
            
            updateSubjectsTable() {
                const tableBody = document.querySelector('#subjectsTable tbody');
                const subjectText = document.getElementById('subjectInput').value;
                const subjects = subjectText.split('\n').filter(s => s.trim()).map(s => s.trim());
                const labSubjects = Array.from(document.getElementById('labSubjects').selectedOptions).map(o => o.value);
                
                tableBody.innerHTML = '';
                subjects.forEach(subject => {
                    const isLab = labSubjects.includes(subject);
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td><strong>${subject}</strong></td>
                        <td><span class="${isLab ? 'lab' : 'regular'}" style="padding: 4px 12px; border-radius: 4px; background: ${isLab ? '#d1ecf1' : '#e8f4fc'}; color: ${isLab ? '#0c5460' : '#2c3e50'};">${isLab ? 'üî¨ Lab' : 'üìö Regular'}</span></td>
                        <td id="teachers-${subject.replace(/\s+/g, '-')}">Loading...</td>
                    `;
                    
                    tableBody.appendChild(row);
                });
            }
            
            updateTeachersTable() {
                const tableBody = document.querySelector('#teachersTable tbody');
                const teacherText = document.getElementById('teacherInput').value;
                const teachers = teacherText.split('\n').filter(t => t.trim());
                
                tableBody.innerHTML = '';
                teachers.forEach(teacherEntry => {
                    const parts = teacherEntry.split(',');
                    if (parts.length >= 2) {
                        const name = parts[0].trim();
                        const subjects = parts.slice(1, -1).map(s => s.trim());
                        const maxPeriods = parts[parts.length - 1].trim();
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><strong>${name}</strong></td>
                            <td>${subjects.map(s => `<span style="display: inline-block; padding: 3px 8px; margin: 2px; background: #3498db; color: white; border-radius: 4px; font-size: 0.9rem;">${s}</span>`).join('')}</td>
                            <td><span style="padding: 4px 12px; background: #2ecc71; color: white; border-radius: 4px;">${maxPeriods}</span></td>
                        `;
                        tableBody.appendChild(row);
                    }
                });
            }
            
            updateClassesTable() {
                const tableBody = document.querySelector('#classesTable tbody');
                const classText = document.getElementById('classesInput').value;
                const classEntries = classText.split('\n').filter(c => c.trim());
                
                tableBody.innerHTML = '';
                classEntries.forEach(entry => {
                    const parts = entry.split(',');
                    if (parts.length >= 2) {
                        const className = parts[0].trim();
                        const sectionCount = parseInt(parts[1]) || 1;
                        const estimatedStudents = sectionCount * 40; // Assuming 40 students per section
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><strong>${className}</strong></td>
                            <td>
                                ${Array.from({length: sectionCount}, (_, i) => 
                                    `<span style="display: inline-block; padding: 3px 8px; margin: 2px; background: #9b59b6; color: white; border-radius: 4px; font-size: 0.9rem;">Section ${String.fromCharCode(65 + i)}</span>`
                                ).join('')}
                            </td>
                            <td>~${estimatedStudents} students</td>
                        `;
                        tableBody.appendChild(row);
                    }
                });
            }
            
            updateRoomsTable() {
                const tableBody = document.querySelector('#roomsTable tbody');
                const roomCount = parseInt(document.getElementById('roomCount').value) || 25;
                const labCount = parseInt(document.getElementById('labCount').value) || 4;
                
                tableBody.innerHTML = '';
                
                // Regular classrooms
                const row1 = document.createElement('tr');
                row1.innerHTML = `
                    <td>üè´ Regular Classrooms</td>
                    <td>${roomCount}</td>
                    <td>40-45 students each</td>
                `;
                tableBody.appendChild(row1);
                
                // Laboratories
                const row2 = document.createElement('tr');
                row2.innerHTML = `
                    <td>üî¨ Laboratories</td>
                    <td>${labCount}</td>
                    <td>30 students each</td>
                `;
                tableBody.appendChild(row2);
            }
            
            async generateCompleteTimetable() {
                this.showLoading(true);
                
                try {
                    // Parse configuration
                    this.parseConfiguration();
                    
                    // Generate data structures
                    this.generateDataStructures();
                    
                    // Generate timetables using TensorFlow.js
                    await this.generateTimetablesWithAI();
                    
                    // Display results
                    this.displayTimetables();
                    this.updateStatistics();
                    
                    this.showSuccess("Complete timetable generated successfully!");
                    this.switchTab('timetable');
                } catch (error) {
                    this.showError(`Error generating timetable: ${error.message}`);
                } finally {
                    this.showLoading(false);
                }
            }
            
            parseConfiguration() {
                // Parse basic configuration
                this.schoolData.days = parseInt(document.getElementById('schoolDays').value) || 6;
                this.schoolData.periods = parseInt(document.getElementById('periodsPerDay').value) || 8;
                this.schoolData.periodDuration = parseInt(document.getElementById('periodDuration').value) || 45;
                this.schoolData.breakPeriods = (document.getElementById('breakPeriods').value || '3,6')
                    .split(',')
                    .map(p => parseInt(p.trim()))
                    .filter(p => !isNaN(p));
                
                // Parse subjects
                const subjectText = document.getElementById('subjectInput').value;
                this.schoolData.subjects = subjectText.split('\n')
                    .filter(s => s.trim())
                    .map(s => s.trim());
                
                // Parse lab subjects
                const labSubjects = Array.from(document.getElementById('labSubjects').selectedOptions)
                    .map(o => o.value);
                
                // Parse teachers
                const teacherText = document.getElementById('teacherInput').value;
                this.schoolData.teachers = teacherText.split('\n')
                    .filter(t => t.trim())
                    .map(entry => {
                        const parts = entry.split(',');
                        return {
                            name: parts[0].trim(),
                            subjects: parts.slice(1, -1).map(s => s.trim()),
                            maxPeriodsPerDay: parseInt(parts[parts.length - 1]) || 6
                        };
                    });
                
                // Parse classes and sections
                const classText = document.getElementById('classesInput').value;
                this.schoolData.classes = [];
                
                classText.split('\n')
                    .filter(c => c.trim())
                    .forEach(entry => {
                        const parts = entry.split(',');
                        if (parts.length >= 2) {
                            const className = parts[0].trim();
                            const sectionCount = parseInt(parts[1]) || 1;
                            
                            for (let i = 0; i < sectionCount; i++) {
                                this.schoolData.classes.push({
                                    name: className,
                                    section: String.fromCharCode(65 + i), // A, B, C, etc.
                                    fullName: `${className} - Section ${String.fromCharCode(65 + i)}`
                                });
                            }
                        }
                    });
                
                // Generate rooms
                const roomCount = parseInt(document.getElementById('roomCount').value) || 25;
                const labCount = parseInt(document.getElementById('labCount').value) || 4;
                
                this.schoolData.rooms = [];
                this.schoolData.labs = [];
                
                for (let i = 1; i <= roomCount; i++) {
                    this.schoolData.rooms.push(`Room ${i}`);
                }
                
                for (let i = 1; i <= labCount; i++) {
                    this.schoolData.labs.push(`Lab ${i}`);
                }
            }
            
            generateDataStructures() {
                // Create subject-teacher mapping
                this.schoolData.subjectTeachers = {};
                
                this.schoolData.subjects.forEach(subject => {
                    this.schoolData.subjectTeachers[subject] = 
                        this.schoolData.teachers.filter(teacher => 
                            teacher.subjects.includes(subject)
                        ).map(teacher => teacher.name);
                });
                
                // Create teacher availability tracking
                this.schoolData.teacherSchedule = {};
                this.schoolData.teachers.forEach(teacher => {
                    this.schoolData.teacherSchedule[teacher.name] = {
                        dailyPeriods: new Array(this.schoolData.days).fill(0),
                        assignments: []
                    };
                });
            }
            
            async generateTimetablesWithAI() {
                const totalGenerations = 200;
                const populationSize = 100;
                
                // Initialize population
                let population = this.initializePopulation(populationSize);
                let bestIndividual = null;
                let bestFitness = 0;
                
                for (let gen = 0; gen < totalGenerations; gen++) {
                    // Update loading display
                    this.updateLoadingDisplay(gen, totalGenerations, `Generation ${gen + 1}/${totalGenerations}`);
                    
                    // Calculate fitness for all individuals
                    const fitnessScores = await Promise.all(
                        population.map(ind => this.calculateFitness(ind))
                    );
                    
                    // Find best individual
                    const maxFitness = Math.max(...fitnessScores);
                    const bestIndex = fitnessScores.indexOf(maxFitness);
                    
                    if (maxFitness > bestFitness) {
                        bestFitness = maxFitness;
                        bestIndividual = JSON.parse(JSON.stringify(population[bestIndex]));
                    }
                    
                    // Create next generation
                    population = this.evolvePopulation(population, fitnessScores);
                    
                    // Early stopping
                    if (bestFitness > 95) break;
                    
                    // Yield to UI
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
                
                this.schoolData.timetables = bestIndividual;
                this.optimizationStats.fitness = bestFitness;
                this.optimizationStats.generations = totalGenerations;
            }
            
            initializePopulation(size) {
                const population = [];
                
                for (let i = 0; i < size; i++) {
                    const timetable = this.createRandomTimetable();
                    population.push(timetable);
                }
                
                return population;
            }
            
            createRandomTimetable() {
                const timetable = {};
                
                this.schoolData.classes.forEach(cls => {
                    const classTimetable = [];
                    
                    for (let day = 0; day < this.schoolData.days; day++) {
                        const daySchedule = [];
                        
                        for (let period = 0; period < this.schoolData.periods; period++) {
                            // Skip break periods
                            if (this.schoolData.breakPeriods.includes(period + 1)) {
                                daySchedule.push({ type: 'break', subject: 'Break', teacher: '', room: '' });
                                continue;
                            }
                            
                            // Randomly select subject
                            const subject = this.schoolData.subjects[
                                Math.floor(Math.random() * this.schoolData.subjects.length)
                            ];
                            
                            // Select teacher for this subject
                            const availableTeachers = this.schoolData.subjectTeachers[subject] || [];
                            const teacher = availableTeachers.length > 0 
                                ? availableTeachers[Math.floor(Math.random() * availableTeachers.length)]
                                : 'TBD';
                            
                            // Select room (lab for lab subjects, regular room otherwise)
                            const isLabSubject = Array.from(document.getElementById('labSubjects').selectedOptions)
                                .map(o => o.value).includes(subject);
                            const room = isLabSubject
                                ? this.schoolData.labs[Math.floor(Math.random() * this.schoolData.labs.length)]
                                : this.schoolData.rooms[Math.floor(Math.random() * this.schoolData.rooms.length)];
                            
                            daySchedule.push({
                                subject,
                                teacher,
                                room,
                                type: isLabSubject ? 'lab' : 'regular'
                            });
                        }
                        
                        classTimetable.push(daySchedule);
                    }
                    
                    timetable[cls.fullName] = classTimetable;
                });
                
                return timetable;
            }
            
            async calculateFitness(timetable) {
                let fitness = 100;
                
                // Check for teacher conflicts
                const conflicts = this.countConflicts(timetable);
                fitness -= conflicts * 5;
                
                // Check teacher workload
                const workloadScore = this.checkTeacherWorkload(timetable);
                fitness -= workloadScore;
                
                // Check room conflicts
                const roomConflicts = this.checkRoomConflicts(timetable);
                fitness -= roomConflicts * 3;
                
                // Check subject distribution
                const distributionScore = this.checkSubjectDistribution(timetable);
                fitness += distributionScore;
                
                return Math.max(0, Math.min(100, fitness));
            }
            
            countConflicts(timetable) {
                let conflicts = 0;
                
                // For each day and period, check if any teacher is scheduled in multiple classes
                for (let day = 0; day < this.schoolData.days; day++) {
                    for (let period = 0; period < this.schoolData.periods; period++) {
                        const teacherAssignments = {};
                        
                        Object.values(timetable).forEach(classTimetable => {
                            const slot = classTimetable[day][period];
                            if (slot.type !== 'break' && slot.teacher && slot.teacher !== 'TBD') {
                                if (teacherAssignments[slot.teacher]) {
                                    teacherAssignments[slot.teacher]++;
                                    conflicts++;
                                } else {
                                    teacherAssignments[slot.teacher] = 1;
                                }
                            }
                        });
                    }
                }
                
                this.optimizationStats.conflicts = conflicts;
                return conflicts;
            }
            
            checkTeacherWorkload(timetable) {
                let penalty = 0;
                const teacherWorkload = {};
                
                // Initialize workload tracking
                this.schoolData.teachers.forEach(teacher => {
                    teacherWorkload[teacher.name] = new Array(this.schoolData.days).fill(0);
                });
                
                // Count periods for each teacher each day
                Object.values(timetable).forEach(classTimetable => {
                    for (let day = 0; day < this.schoolData.days; day++) {
                        for (let period = 0; period < this.schoolData.periods; period++) {
                            const slot = classTimetable[day][period];
                            if (slot.type !== 'break' && slot.teacher && slot.teacher !== 'TBD') {
                                if (teacherWorkload[slot.teacher]) {
                                    teacherWorkload[slot.teacher][day]++;
                                }
                            }
                        }
                    }
                });
                
                // Check if any teacher exceeds max periods per day
                this.schoolData.teachers.forEach(teacher => {
                    if (teacherWorkload[teacher.name]) {
                        teacherWorkload[teacher.name].forEach(dailyLoad => {
                            if (dailyLoad > teacher.maxPeriodsPerDay) {
                                penalty += (dailyLoad - teacher.maxPeriodsPerDay) * 3;
                            }
                        });
                    }
                });
                
                return penalty;
            }
            
            checkRoomConflicts(timetable) {
                let conflicts = 0;
                
                for (let day = 0; day < this.schoolData.days; day++) {
                    for (let period = 0; period < this.schoolData.periods; period++) {
                        const roomAssignments = {};
                        
                        Object.values(timetable).forEach(classTimetable => {
                            const slot = classTimetable[day][period];
                            if (slot.type !== 'break' && slot.room) {
                                if (roomAssignments[slot.room]) {
                                    conflicts++;
                                } else {
                                    roomAssignments[slot.room] = true;
                                }
                            }
                        });
                    }
                }
                
                return conflicts;
            }
            
            checkSubjectDistribution(timetable) {
                let score = 0;
                
                Object.entries(timetable).forEach(([className, classTimetable]) => {
                    const subjectCounts = {};
                    
                    // Count subject occurrences
                    for (let day = 0; day < this.schoolData.days; day++) {
                        for (let period = 0; period < this.schoolData.periods; period++) {
                            const slot = classTimetable[day][period];
                            if (slot.type !== 'break' && slot.subject) {
                                subjectCounts[slot.subject] = (subjectCounts[slot.subject] || 0) + 1;
                            }
                        }
                    }
                    
                    // Calculate distribution score (more even distribution is better)
                    const totalSlots = this.schoolData.days * (this.schoolData.periods - this.schoolData.breakPeriods.length);
                    let entropy = 0;
                    
                    Object.values(subjectCounts).forEach(count => {
                        const probability = count / totalSlots;
                        entropy -= probability * Math.log(probability);
                    });
                    
                    score += entropy * 10; // Scale entropy to meaningful score
                });
                
                return score / Object.keys(timetable).length;
            }
            
            evolvePopulation(population, fitnessScores) {
                const newPopulation = [];
                const totalFitness = fitnessScores.reduce((a, b) => a + b, 0);
                
                // Elitism: keep best individual
                const bestIndex = fitnessScores.indexOf(Math.max(...fitnessScores));
                newPopulation.push(population[bestIndex]);
                
                // Generate rest of population
                while (newPopulation.length < population.length) {
                    const parent1 = this.selectParent(population, fitnessScores, totalFitness);
                    const parent2 = this.selectParent(population, fitnessScores, totalFitness);
                    const child = this.crossover(parent1, parent2);
                    this.mutate(child);
                    newPopulation.push(child);
                }
                
                return newPopulation;
            }
            
            selectParent(population, fitnessScores, totalFitness) {
                let threshold = Math.random() * totalFitness;
                let sum = 0;
                
                for (let i = 0; i < population.length; i++) {
                    sum += fitnessScores[i];
                    if (sum >= threshold) {
                        return population[i];
                    }
                }
                
                return population[population.length - 1];
            }
            
            crossover(parent1, parent2) {
                const child = {};
                const classes = Object.keys(parent1);
                
                classes.forEach(className => {
                    const childTimetable = [];
                    
                    for (let day = 0; day < this.schoolData.days; day++) {
                        const daySchedule = [];
                        
                        for (let period = 0; period < this.schoolData.periods; period++) {
                            // Randomly choose from parent1 or parent2
                            const useParent1 = Math.random() > 0.5;
                            const source = useParent1 ? parent1[className] : parent2[className];
                            
                            if (source[day][period].type === 'break') {
                                daySchedule.push({ type: 'break', subject: 'Break', teacher: '', room: '' });
                            } else {
                                daySchedule.push({ ...source[day][period] });
                            }
                        }
                        
                        childTimetable.push(daySchedule);
                    }
                    
                    child[className] = childTimetable;
                });
                
                return child;
            }
            
            mutate(timetable) {
                const mutationRate = 0.02;
                const classes = Object.keys(timetable);
                
                classes.forEach(className => {
                    for (let day = 0; day < this.schoolData.days; day++) {
                        for (let period = 0; period < this.schoolData.periods; period++) {
                            if (Math.random() < mutationRate && timetable[className][day][period].type !== 'break') {
                                // Mutate this slot
                                const slot = timetable[className][day][period];
                                const subject = this.schoolData.subjects[
                                    Math.floor(Math.random() * this.schoolData.subjects.length)
                                ];
                                
                                const availableTeachers = this.schoolData.subjectTeachers[subject] || [];
                                const teacher = availableTeachers.length > 0 
                                    ? availableTeachers[Math.floor(Math.random() * availableTeachers.length)]
                                    : 'TBD';
                                
                                const isLabSubject = Array.from(document.getElementById('labSubjects').selectedOptions)
                                    .map(o => o.value).includes(subject);
                                const room = isLabSubject
                                    ? this.schoolData.labs[Math.floor(Math.random() * this.schoolData.labs.length)]
                                    : this.schoolData.rooms[Math.floor(Math.random() * this.schoolData.rooms.length)];
                                
                                slot.subject = subject;
                                slot.teacher = teacher;
                                slot.room = room;
                                slot.type = isLabSubject ? 'lab' : 'regular';
                            }
                        }
                    }
                });
            }
            
            displayTimetables() {
                const classSelector = document.getElementById('classSelector');
                classSelector.innerHTML = '';
                
                // Create tabs for each class
                this.schoolData.classes.forEach(cls => {
                    const tab = document.createElement('div');
                    tab.className = 'class-tab';
                    tab.textContent = cls.fullName;
                    tab.dataset.className = cls.fullName;
                    
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.class-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        this.currentClassView = cls.fullName;
                        this.displayTimetable(cls.fullName);
                    });
                    
                    classSelector.appendChild(tab);
                });
                
                // Activate first class
                if (this.schoolData.classes.length > 0) {
                    const firstTab = document.querySelector('.class-tab');
                    if (firstTab) {
                        firstTab.classList.add('active');
                        this.currentClassView = this.schoolData.classes[0].fullName;
                        this.displayTimetable(this.currentClassView);
                    }
                }
            }
            
            displayTimetable(className) {
                if (!this.schoolData.timetables || !this.schoolData.timetables[className]) {
                    return;
                }
                
                const timetable = this.schoolData.timetables[className];
                const container = document.getElementById('mainTimetable');
                
                // Build HTML table
                let html = '<table>';
                
                // Header row
                html += '<thead><tr>';
                html += '<th class="time-slot">Period</th>';
                
                for (let day = 1; day <= this.schoolData.days; day++) {
                    html += `<th>Day ${day}</th>`;
                }
                
                html += '</tr></thead><tbody>';
                
                // Time slots
                for (let period = 0; period < this.schoolData.periods; period++) {
                    const timeSlot = this.getTimeSlot(period);
                    
                    html += '<tr>';
                    html += `<td class="time-slot">${timeSlot}</td>`;
                    
                    for (let day = 0; day < this.schoolData.days; day++) {
                        const slot = timetable[day][period];
                        const isConflict = this.checkSlotConflict(className, day, period);
                        
                        if (slot.type === 'break') {
                            html += `<td style="background: #f8f9fa; color: #6c757d; font-style: italic;">
                                        üçé Break
                                    </td>`;
                        } else {
                            html += `<td>
                                        <div class="subject-cell ${isConflict ? 'conflict' : ''}">
                                            <div class="subject-name">${slot.subject}</div>
                                            <div class="teacher-name">üë®‚Äçüè´ ${slot.teacher}</div>
                                            <div class="room-number">${slot.type === 'lab' ? 'üî¨' : 'üè´'} ${slot.room}</div>
                                        </div>
                                    </td>`;
                        }
                    }
                    
                    html += '</tr>';
                }
                
                html += '</tbody></table>';
                container.innerHTML = html;
            }
            
            getTimeSlot(period) {
                const startHour = 8;
                const periodDuration = this.schoolData.periodDuration;
                const totalMinutes = period * periodDuration;
                
                // Add break time
                let breakAdjustment = 0;
                this.schoolData.breakPeriods.forEach(breakPeriod => {
                    if (period >= breakPeriod) breakAdjustment += 15; // 15 minute breaks
                });
                
                const adjustedMinutes = totalMinutes + breakAdjustment;
                const hour = startHour + Math.floor(adjustedMinutes / 60);
                const minute = adjustedMinutes % 60;
                
                const endMinutes = adjustedMinutes + periodDuration;
                const endHour = startHour + Math.floor(endMinutes / 60);
                const endMinute = endMinutes % 60;
                
                return `Period ${period + 1}<br>${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')} - ${endHour.toString().padStart(2, '0')}:${endMinute.toString().padStart(2, '0')}`;
            }
            
            checkSlotConflict(className, day, period) {
                const slot = this.schoolData.timetables[className][day][period];
                if (slot.type === 'break') return false;
                
                // Check teacher conflict
                let teacherConflict = false;
                Object.entries(this.schoolData.timetables).forEach(([otherClass, otherTimetable]) => {
                    if (otherClass !== className) {
                        const otherSlot = otherTimetable[day][period];
                        if (otherSlot.type !== 'break' && otherSlot.teacher === slot.teacher) {
                            teacherConflict = true;
                        }
                    }
                });
                
                // Check room conflict
                let roomConflict = false;
                Object.entries(this.schoolData.timetables).forEach(([otherClass, otherTimetable]) => {
                    if (otherClass !== className) {
                        const otherSlot = otherTimetable[day][period];
                        if (otherSlot.type !== 'break' && otherSlot.room === slot.room) {
                            roomConflict = true;
                        }
                    }
                });
                
                return teacherConflict || roomConflict;
            }
            
            updateStatistics() {
                document.getElementById('conflictCount').textContent = this.optimizationStats.conflicts;
                document.getElementById('teacherUtilization').textContent = `${Math.round(this.calculateTeacherUtilization())}%`;
                document.getElementById('roomUtilization').textContent = `${Math.round(this.calculateRoomUtilization())}%`;
                document.getElementById('fitnessScore').textContent = `${Math.round(this.optimizationStats.fitness)}%`;
                document.getElementById('generationCount').textContent = this.optimizationStats.generations;
            }
            
            calculateTeacherUtilization() {
                let totalAssignedPeriods = 0;
                let totalAvailablePeriods = 0;
                
                this.schoolData.teachers.forEach(teacher => {
                    const maxPeriods = teacher.maxPeriodsPerDay * this.schoolData.days;
                    totalAvailablePeriods += maxPeriods;
                    
                    // Count assigned periods
                    let assignedPeriods = 0;
                    Object.values(this.schoolData.timetables).forEach(timetable => {
                        for (let day = 0; day < this.schoolData.days; day++) {
                            for (let period = 0; period < this.schoolData.periods; period++) {
                                const slot = timetable[day][period];
                                if (slot.type !== 'break' && slot.teacher === teacher.name) {
                                    assignedPeriods++;
                                }
                            }
                        }
                    });
                    
                    totalAssignedPeriods += Math.min(assignedPeriods, maxPeriods);
                });
                
                return (totalAssignedPeriods / totalAvailablePeriods) * 100;
            }
            
            calculateRoomUtilization() {
                let totalUsedSlots = 0;
                let totalAvailableSlots = (this.schoolData.rooms.length + this.schoolData.labs.length) * 
                                         this.schoolData.days * 
                                         this.schoolData.periods;
                
                Object.values(this.schoolData.timetables).forEach(timetable => {
                    for (let day = 0; day < this.schoolData.days; day++) {
                        for (let period = 0; period < this.schoolData.periods; period++) {
                            const slot = timetable[day][period];
                            if (slot.type !== 'break' && slot.room) {
                                totalUsedSlots++;
                            }
                        }
                    }
                });
                
                return (totalUsedSlots / totalAvailableSlots) * 100;
            }
            
            // Export functions
            exportAsPDF() {
                alert('PDF export would be implemented here. In a real application, this would generate downloadable PDF files for each class timetable.');
            }
            
            exportAsExcel() {
                alert('Excel export would be implemented here. This would generate an Excel file with all timetables.');
            }
            
            exportAsJSON() {
                const data = {
                    schoolData: this.schoolData,
                    timetables: this.schoolData.timetables,
                    statistics: this.optimizationStats
                };
                
                const jsonString = JSON.stringify(data, null, 2);
                document.getElementById('exportPreview').textContent = jsonString;
                
                // Create download link
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'timetable-data.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showSuccess('Timetable data exported as JSON!');
            }
            
            exportAsCSV() {
                let csvContent = "Class,Day,Period,Subject,Teacher,Room,Type\n";
                
                Object.entries(this.schoolData.timetables).forEach(([className, timetable]) => {
                    for (let day = 0; day < this.schoolData.days; day++) {
                        for (let period = 0; period < this.schoolData.periods; period++) {
                            const slot = timetable[day][period];
                            csvContent += `"${className}","Day ${day + 1}","Period ${period + 1}","${slot.subject}","${slot.teacher}","${slot.room}","${slot.type}"\n`;
                        }
                    }
                });
                
                document.getElementById('exportPreview').textContent = csvContent.substring(0, 1000) + '...';
                
                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'timetable-export.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showSuccess('Timetable data exported as CSV!');
            }
            
            // UI Helper functions
            showLoading(show) {
                document.getElementById('loadingOverlay').style.display = show ? 'block' : 'none';
            }
            
            updateLoadingDisplay(current, total, message) {
                document.getElementById('currentGen').textContent = current + 1;
                document.getElementById('loadingDetails').textContent = message;
                
                const progress = ((current + 1) / total) * 100;
                document.getElementById('progressBar').style.width = `${progress}%`;
            }
            
            showError(message) {
                const errorDiv = document.getElementById('errorMsg');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                document.getElementById('successMsg').style.display = 'none';
            }
            
            showSuccess(message) {
                const successDiv = document.getElementById('successMsg');
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                document.getElementById('errorMsg').style.display = 'none';
            }
        }
        
        // Initialize the complete timetable generator
        document.addEventListener('DOMContentLoaded', () => {
            window.timetableSystem = new CompleteTimetableGenerator();
        });
    </script>
</body>
</html>